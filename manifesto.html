<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://fonts.googleapis.com/css?family=Poppins&display=swap" rel="stylesheet" />
        <link href="style_concat.css" rel="stylesheet" />
        <title>Start Challenges</title>
    </head>
    <body>
        <!-- Sidebar -->
        <div id="mySidenav" class="sidenav">
            <ul>
                <li><a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a></li>
                <!-- <li><a href="index.html">Home</a></li>
                <li><a href="qualtrics.html"><b>Quiz</b></a></li> -->
                <li><a href="manifesto.html">Challenge</a></li>
                <li><a href="result_page.html">Dashboard</a></li>
                <li><!-- <a href="#">About us</a> --></li>
            </ul>
        </div>
        <div class="container">
            <div class="spinner hidden" id="spinner"></div>
            <div class="header">
                <h2 class="logo">planeatary - logo</h2>
                <span style="font-size:2em;cursor:pointer" onclick="openNav()">&#9776;</span>
                <nav class="forwindow">
                    <ul>
                        <!-- <li><a href="index.html">Home</a></li>
                        <li><a href="qualtrics.html"><b>Quiz</b></a></li> -->
                        <li><a href="manifesto.html">Challenge</a></li>
                        <li><a href="result_page.html">Dashboard</a></li>
                        <!-- <li>About us</li> -->
                    </ul>
                </nav>
                <!-- <div class="button">
                    <button class="signIn">Sign In</button>
                    <span>&ensp;</span>
                    <button class="signUp">Sign Up</button>
                </div> -->
            </div>
            <div class="subheader">
                <p id="tentask"></p>
            </div>
            <div class="button2">
                <button class="start"><a href="challenge_page.html">Start</a></button>
            </div>
            <div class="improvement">
                <button id="good">Good scores</button>
                <button id="notyet">Need improvement</button>
            </div>
            <div class="task-content">
                <div class="q-task">
                    <!--<ul id="q2">
                        <li>
                            <p>Question <span id="q_num2"></span> - <span id="q_score2"></span><img src="./images/info.png" onclick="Modal();" /></p>
                        </li>
                        <li>
                            <lable>
                                <input  type="checkbox" name="task" value="Living"/> Eat to live or live to eat
                            </label>
                            <img src="./images/info2.png" onclick="Modal();" />
                        </li>
                        <li>
                            <label>
                                <input  type="checkbox" name="task" value="Blackpink"/> Don't know what to do without you
                            </label>
                            <img src="./images/info2.png" onclick="Modal();" />
                        </li>
                        <li>
                            <label>
                                <input  type="checkbox" name="task" value="Deadline"/> Don't do if we can finish by the deadline
                            </label>
                            <img src="./images/info2.png" onclick="Modal();" />
                        </li>
                    </ul>-->
                </div>
            </div>
        </div>
        <!-- The Modal -->
        <section class="overlay hidden">
                <div class="align">
                    <div class="modal hidden"> 
                        <div class="btn">
                            <button class="close" onclick="Close();">x</button>
                        </div>
                        <div class="modal-content">
                            <img id="inform"/>
                        </div>
                    </div>
                </div>
        </section>
        <script>

            const modal = document.querySelector(".modal");
            const overlay = document.querySelector(".overlay");

            function Modal(source) {
                const modalContent = document.querySelector(".modal-content");
                const image = document.getElementById("inform");
                image.src = source;
                modal.classList.remove('hidden');
                overlay.classList.remove('hidden');
            };

            function Close() {
                modal.classList.add("hidden");
                overlay.classList.add('hidden');
            };

            function openNav() {
                document.getElementById("mySidenav").style.width = "40%";
                document.body.style.backgroundColor = "rgba(0,0,0,0.4)";
            };

            function closeNav() {
                document.getElementById("mySidenav").style.width = "0";
                document.body.style.backgroundColor = "white";
            };

            const QContainer = document.querySelector(".q-task");

            const good = document.getElementById("good");
            const bad = document.getElementById("notyet");

            
            good.style.backgroundColor = '#a9d1cd';
            bad.style.backgroundColor = '#02897A';

            document.addEventListener("DOMContentLoaded", async function() {
                const startButton = document.querySelector(".start");
                const spinner = document.getElementById('spinner');
                let isLoading = false;
                const minDisplayTime = 2000; 
                let spinnerStartTime;
                let scores = [];
                let task_counts = 0;

                // Function to show the spinner
                function showSpinner() {
                    //console.log("Showing spinner...");
                    spinner.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                    isLoading = true;
                    spinnerStartTime = Date.now();
                };
                
                // Function to hide the spinner
                function hideSpinner() {
                    const elapsedTime = Date.now() - spinnerStartTime;
                    if (elapsedTime < minDisplayTime) {
                        // Delay hiding spinner until the minimum display time
                        setTimeout(() => {
                            //console.log("Hiding spinner after min time...");
                            spinner.classList.add('hidden');
                            overlay.classList.add('hidden');
                            isLoading = false;
                        }, minDisplayTime - elapsedTime);
                    } else {
                        //console.log("Hiding spinner...");
                        spinner.classList.add('hidden');
                        overlay.classList.add('hidden');
                        isLoading = false;
                    }
                };

                let preResult = JSON.parse(localStorage.getItem('preResult')); 

                let preResponseId = localStorage.getItem('preResponseId'); 

                let preTotalScore = preResult.totalScore; 

                let prePointArray = preResult.pointArray 

                // async function fetchResponseIdFromNetlify(quizType='pre', responseId) {
                //     try {
                //         const endpoint = `/api/fetch-response?quizType=${quizType}`;
                //         const options = {
                //             method: 'GET',
                //             headers: {
                //                 'Content-Type': 'application/json',
                //                 'Q-RESPONSE-ID': responseId,
                //             },
                //         };

                //         // Fetch the responseId from the Netlify endpoint
                //         const response = await fetch(endpoint, options);

                //         // Check if the response is successful
                //         if (!response.ok) {
                //             throw new Error('Failed to fetch response ID');
                //         }

                //         // Parse the JSON response
                //         const data = await response.json();

                //         return data;
                        
                //     } catch (error) {
                //         console.error('Error fetching response ID from Netlify:', error);
                //         return null; 
                //     }
                // }


                async function fetchTasks() {
                try {
                        const response = await fetch('updated_tasks_final.json');
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        const data = await response.json();
                        return data;
                    } catch (error) {
                        console.error('Fetch error:', error);
                        select.display = 'none';
                        alert('Failed to load tasks. Please try again later.');

                    }
                }

                async function fetchTasksFromNetlify() {
                    try {
                        showSpinner();
                        const response = await fetch('/api/manage-tasks', {
                            method: 'GET',
                            headers: {
                                'Q-RESPONSE-ID': preResponseId, 
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            throw new Error('Failed to fetch tasks');
                        }
                        const data = await response.json();
                        if (!preResult) {
                            handleFetchedData(preResult, data);
                        };
                        
                    } catch (error) {
                        hideSpinner();
                        console.error('Error fetching tasks:', error);
                        return null;
                    }
                }
                
                
                if (preResult) {
                    try {
                        const Task = await fetchTasks();  // Await the result of the fetchTasks function
                        localStorage.setItem('tasks', JSON.stringify(Task));  // Store the fetched tasks as a JSON string
                        const tasks = JSON.parse(localStorage.getItem('tasks'));
                        scores = preResult.pointArray;
                        scores.forEach((score, i) => {
                            tasks.forEach((task, j) => {
                                if (task.tasks.choice === "selected") {
                                    task_counts += 1;
                                }
                            });
                        });
                        updateStartButton();
                        renderTasks(score => score.score <= 3);
                        hideSpinner();  // Hide spinner after tasks are fetched and processed
                    } catch (error) {
                        alert('Failed to load tasks. Please try again later.');
                        hideSpinner();
                        console.error("Error:", error);
                        document.body.innerHTML = 'Looks like we are experiencing issues in displaying tasks. Please try again later.';
                    }
                } else {
                    document.body.innerHTML = 'Looks like we are experiencing issues in displaying tasks. Please try again later.';
                }

            // Function to update start button state
            function updateStartButton() {
                persuade = document.getElementById("tentask");
                if (task_counts >= 10) {
                    persuade.innerHTML = 'You’ve selected 10 tasks. Start challenge now';
                    persuade.style.color = 'black';
                    startButton.style.pointerEvents = "auto";
                    startButton.style.backgroundColor = "#02897A";
                    //startButton.style.transition = "all 1s";
                } else {
                    persuade.innerHTML = `Number of selected tasks: ${task_counts}`;
                    persuade.style.color = 'grey';
                    startButton.style.pointerEvents = "none";
                    startButton.style.backgroundColor = "grey";
                    //startButton.style.transition = "all 1s";
                }
            }

            function renderTasksForQuestion(questionNumber) {
                const taskGroup = tasks[questionNumber];  

                if (taskGroup && taskGroup.tasks) {
                    taskGroup.tasks.forEach(task => {
                        const q_input = document.createElement("li");
                        const label = document.createElement("label");
                        const input = document.createElement("input");
                        const text = document.createElement("span");
                        text.innerHTML = task.taskName;
                        input.type = "checkbox";
                        
                        // Initialize task count based on current selected state
                        if (task.choice === "selected") {
                            input.checked = true;
                        }
                        
                        label.appendChild(input);
                        label.appendChild(text);
                        q_input.appendChild(label);
                        q_con.appendChild(q_input);
                        
                        // Event listener to track selection
                        input.addEventListener('change', function() {
                            if (input.checked) {
                                task.choice = "selected";
                                task_counts += 1;
                            } else {
                                task.choice = "not selected";
                                task_counts -= 1;
                            }
                            
                            // Save updated task state to localStorage
                            localStorage.setItem("user", JSON.stringify(scores));
                            
                            // Update the start button
                            updateStartButton();
                        });
                    });
                } else {
                    QContainer.innerHTML = '<p>No tasks found for this question.</p>';
                }
            }

            function renderTasks(scoreCondition) {
                QContainer.innerHTML = ''; 
                const tasks = JSON.parse(localStorage.getItem('tasks'));

                scores.forEach((score, i) => {
                    if (scoreCondition(score)) {
                        const btnContainer = document.createElement("div");
                        const q_button = document.createElement("button");    
                        const q_con = document.createElement("ul");
                        q_con.classList.add("q");
                        

                        btnContainer.classList.add("btn-q");
                        q_button.classList.add("next");
                        q_button.textContent = `Question ${i+1}`;
                        btnContainer.appendChild(q_button);


                        q_button.addEventListener('click', function () {


                            if (q_con.innerHTML === 'none' || q_con.innerHTML === '') {
                                const question = document.createElement("li");
                                question.id = `q_num${i+1}`;
                                const q_num = document.createElement("span");
                                q_num.textContent = `Question ${i+1} - ${score.score} points`;
                                const q_info = document.createElement("img");
                                q_info.src = './images/info.png';
                                q_info.width = '16';  
                                if(score.score > 3) {
                                    q_con.style.boxShadow = '0px 6px 8px 0px rgba(0, 128, 0, 0.5)';
                                } else {
                                    q_con.style.boxShadow = '0px 6px 8px 0px rgba(255, 0, 0, 0.5)';
                                };
                                q_con.appendChild(question);
                                question.appendChild(q_num);
                                question.appendChild(q_info);

                                q_info.addEventListener('click', function() {
                                    Modal(`./images/pop${i+1}.jpg`);
                                });
                                renderTasksForQuestion();
                            } else {
                                q_con.style.boxShadow = 'none';
                                q_con.innerHTML = ''; 
                            }
                            
                        });
                        QContainer.appendChild(btnContainer);
                        QContainer.appendChild(q_con);
                    }
                    
                });

                // Update start button state after rendering tasks
                updateStartButton();
            }
            // Event listener for "good" button
            document.getElementById('good').addEventListener('click', function() {
                updateStartButton();
                renderTasks(score => score.score > 3);
                good.style.backgroundColor = '#02897A';
                good.style.transition = "all 1s";
                bad.style.backgroundColor = '#a9d1cd';
                bad.style.transition = "all 1s";
            });

            // Event listener for "bad" button
            document.getElementById('notyet').addEventListener('click', function() {
                updateStartButton();
                renderTasks(score => score.score <= 3);
                good.style.backgroundColor = '#a9d1cd';
                good.style.transition = "all 1s";
                bad.style.backgroundColor = '#02897A';
                bad.style.transition = "all 1s";
            });

            // Attach single click listener for the start button navigation
            startButton.addEventListener('click', function(event) {
                if (task_counts >= 10) {
                    window.location.href = "challenge_page.html";
                }
            });
        });
        </script>
    </body>
</html>
