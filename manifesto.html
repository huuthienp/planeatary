<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://fonts.googleapis.com/css?family=Poppins&display=swap" rel="stylesheet" />
        <link href="style_concat.css" rel="stylesheet" />
        <title>Start Challenges</title>
    </head>
    <body>
        <!-- Sidebar -->
        <div id="mySidenav" class="sidenav">
            <ul>
                <li><a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a></li>
                <li><a href="index.html">Home</a></li>
                <li><a href="qualtrics.html"><b>Quiz</b></a></li>
                <li><a href="manifesto.html">Challenge</a></li>
                <li><a href="result_page.html">Dashboard</a></li>
                <li><!-- <a href="#">About us</a> --></li>
            </ul>
        </div>
        <div class="container">
            <div class="spinner hidden" id="spinner"></div>
            <div class="header">
                <h2 class="logo">planeatary - logo</h2>
                <span style="font-size:2em;cursor:pointer" onclick="openNav()">&#9776;</span>
                <nav class="forwindow">
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="qualtrics.html"><b>Quiz</b></a></li>
                        <li><a href="manifesto.html">Challenge</a></li>
                        <li><a href="result_page.html">Dashboard</a></li>
                        <!-- <li>About us</li> -->
                    </ul>
                </nav>
                <!-- <div class="button">
                    <button class="signIn">Sign In</button>
                    <span>&ensp;</span>
                    <button class="signUp">Sign Up</button>
                </div> -->
            </div>
            <div class="subheader">
                <p id="tentask"></p>
            </div>
            <div class="button2">
                <button class="start"><a href="challenge_page.html">Start</a></button>
            </div>
            <div class="improvement">
                <button id="good">Good scores</button>
                <button id="notyet">Need improvement</button>
            </div>
            <div class="task-content">
                <div class="q-task">

                    <!--<ul id="q2">
                        <li>
                            <p>Question <span id="q_num2"></span> - <span id="q_score2"></span><img src="./images/info.png" onclick="Modal();" /></p>
                        </li>
                        <li>
                            <lable>
                                <input  type="checkbox" name="task" value="Living"/> Eat to live or live to eat
                            </label>
                            <img src="./images/info2.png" onclick="Modal();" />
                        </li>
                        <li>
                            <label>
                                <input  type="checkbox" name="task" value="Blackpink"/> Don't know what to do without you
                            </label>
                            <img src="./images/info2.png" onclick="Modal();" />
                        </li>
                        <li>
                            <label>
                                <input  type="checkbox" name="task" value="Deadline"/> Don't do if we can finish by the deadline
                            </label>
                            <img src="./images/info2.png" onclick="Modal();" />
                        </li>
                    </ul>-->
                </div>
            </div>
        </div>
        <!-- The Modal -->
        <section class="overlay hidden">
                <div class="align">
                    <div class="modal hidden"> 
                        <div class="btn">
                            <button class="close" onclick="Close();">x</button>
                        </div>
                        <div class="modal-content">
                        </div>
                    </div>
                </div>
        </section>
        <script>
            function Modal(source) {
                const modal = document.querySelector(".modal");
                const overlay = document.querySelector(".overlay");
                const modalContent = document.querySelector('.modal-content');

                // Clear any existing content
                modalContent.innerHTML = '';

                // Create an object element to display the PDF
                const pdfObject = document.createElement('object');
                pdfObject.classList.add('visual-info');
                pdfObject.data = source;
                pdfObject.type = "application/pdf";
                pdfObject.width = '100%';
                pdfObject.height = '100%';
                pdfObject.style.border = 'none';

                // Optional: Provide a fallback message
                const fallbackMessage = document.createElement('p');
                fallbackMessage.innerHTML = 'Your browser does not support PDFs.';
                pdfObject.appendChild(fallbackMessage);

                // Append the object to the modal content
                modalContent.appendChild(pdfObject);

                // Show the modal and overlay
                modal.classList.remove('hidden');
                overlay.classList.remove('hidden');
            }
            // When the user clicks on <span> (x), close the modal
            function Close() {
                var modal = document.querySelector(".modal");
                var overlay = document.querySelector(".overlay");
                modal.classList.add("hidden");
                overlay.classList.add('hidden');
            }

            function openNav() {
            document.getElementById("mySidenav").style.width = "40%";
            document.body.style.backgroundColor = "rgba(0,0,0,0.4)";
            }

            function closeNav() {
                document.getElementById("mySidenav").style.width = "0";
                document.body.style.backgroundColor = "white";
            }


            const modal = document.querySelector(".modal");
            const overlay = document.querySelector(".overlay");
            const spinner = document.querySelector(".spinner");

            const good = document.getElementById("good");
            const bad = document.getElementById("notyet");
            const QContainer = document.querySelector(".q-task");

            const startButton = document.querySelector(".start");
            good.style.backgroundColor = '#a9d1cd';
            bad.style.backgroundColor = '#02897A';

            document.addEventListener("DOMContentLoaded", async function() {
                const spinner = document.getElementById('spinner');
                let isLoading = false;
                const minDisplayTime = 2000; 
                let spinnerStartTime;

                // Function to show the spinner
                function showSpinner() {
                    //console.log("Showing spinner...");
                    spinner.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                    isLoading = true;
                    spinnerStartTime = Date.now();
                };
                
                // Function to hide the spinner
                function hideSpinner() {
                    const elapsedTime = Date.now() - spinnerStartTime;
                    if (elapsedTime < minDisplayTime) {
                        // Delay hiding spinner until the minimum display time
                        setTimeout(() => {
                            //console.log("Hiding spinner after min time...");
                            spinner.classList.add('hidden');
                            overlay.classList.add('hidden');
                            isLoading = false;
                        }, minDisplayTime - elapsedTime);
                    } else {
                        console.log("Hiding spinner...");
                        spinner.classList.add('hidden');
                        overlay.classList.add('hidden');
                        isLoading = false;
                    }
                };

                let scores = [];
                let task_counts = 0;
                const QContainer = document.querySelector(".q-task");

                // Check if scores are stored in localStorage
                const storedScore = localStorage.getItem("user");
                showSpinner();

                if (storedScore) {

                    scores = JSON.parse(storedScore);
                    scores.forEach((score, i) => {
                        score.tasks.forEach((task, j) => {
                            if (task.choice === "selected") {
                                task_counts += 1;
                            };
                        });
                        updateStartButton();
                        renderTasks(score => score.score <= 3);
                    });  
                    hideSpinner();    
                } else {            
                    try {
                        const response = await fetch('before_user.json');
                        const data = await response.json();
                        scores = data.postscore || data.prescore;
                        localStorage.setItem("user", JSON.stringify(scores));
                        updateStartButton();
                        renderTasks(score => score.score <= 3);
                    } catch (error) {
                        console.error("Error fetching JSON data:", error);
                        const errorMessage = document.createElement('p');
                        errorMessage.textContent = "Failed to load tasks. Please try again later.";
                        document.body.appendChild(errorMessage);
                    } finally {
                        hideSpinner();
                    }
                };
            

            // Function to update start button state
            function updateStartButton() {
                persuade = document.getElementById("tentask");
                if (task_counts >= 10) {
                    persuade.innerHTML = 'You’ve selected 10 tasks. Start challenge now';
                    persuade.style.color = 'black';
                    startButton.style.pointerEvents = "auto";
                    startButton.style.backgroundColor = "#02897A";
                    //startButton.style.transition = "all 1s";
                } else {
                    persuade.innerHTML = `Number of selected tasks: ${task_counts}`;
                    persuade.style.color = 'grey';
                    startButton.style.pointerEvents = "none";
                    startButton.style.backgroundColor = "grey";
                    //startButton.style.transition = "all 1s";
                }
            };

            function renderTasks(scoreCondition) {
                QContainer.innerHTML = ''; // Clear any existing content

                scores.forEach((score, i) => {
                    if (scoreCondition(score)) {
                        const q_con = document.createElement("ul");
                        q_con.classList.add("q");

                        const question = document.createElement("li");
                        question.id = `q_num${i+1}`;
                        const q_num = document.createElement("span");
                        q_num.textContent = `Question ${i+1} - ${score.score} points`;
                        const q_info = document.createElement("img");
                        q_info.src = './images/info.png';
                        q_info.width = '16';

                        q_con.appendChild(question);
                        question.appendChild(q_num);
                        question.appendChild(q_info);

                        q_info.addEventListener('click', function() {
                            Modal(`./images/Question ${i+1}.pdf`);
                        });

                        score.tasks.forEach((task, j) => {
                            const q_input = document.createElement("li");
                            const label = document.createElement("label");
                            const input = document.createElement("input");
                            const text = document.createElement("span");
                            text.innerHTML = task.taskName;
                            input.type = "checkbox";

                            // Initialize task count based on current selected state
                            if (task.choice === "selected") {
                                input.checked = true;
                            }

                            label.appendChild(input);
                            label.appendChild(text);
                            q_input.appendChild(label);
                            q_con.appendChild(q_input);

                            // Event listener to track selection
                            input.addEventListener('change', function() {
                                if (input.checked) {
                                    task.choice = "selected";
                                    task_counts += 1;
                                } else {
                                    task.choice = "not selected";
                                    task_counts -= 1;
                                }

                                // Save updated task state to localStorage
                                localStorage.setItem("user", JSON.stringify(scores));

                                // Update the start button
                                updateStartButton();
                            });
                        });
                        QContainer.appendChild(q_con);
                    }
                    
                });

                // Update start button state after rendering tasks
                updateStartButton();
            }
            // Event listener for "good" button
            document.getElementById('good').addEventListener('click', function() {
                updateStartButton();
                renderTasks(score => score.score > 3);
                good.style.backgroundColor = '#02897A';
                good.style.transition = "all 1s";
                bad.style.backgroundColor = '#a9d1cd';
                bad.style.transition = "all 1s";
            });

            // Event listener for "bad" button
            document.getElementById('notyet').addEventListener('click', function() {
                updateStartButton();
                renderTasks(score => score.score <= 3);
                good.style.backgroundColor = '#a9d1cd';
                good.style.transition = "all 1s";
                bad.style.backgroundColor = '#02897A';
                bad.style.transition = "all 1s";
            });

            // Attach single click listener for the start button navigation
            startButton.addEventListener('click', function(event) {
                if (task_counts >= 10) {
                    window.location.href = "challenge_page.html";
                }
            });
        });
        </script>
    </body>
</html>
