<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://fonts.googleapis.com/css?family=Poppins&display=swap" rel="stylesheet" />
        <link href="style_concat.css" rel="stylesheet" />
        <title>PlanEATary Home</title>
    </head>
    <body>
        <!-- Sidebar-->
        <!-- <div id="mySidenav" class="sidenav">
             <ul>
                <li><a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a></li>
                <li id="Home"><a href="index.html">Home</a></li>
                <li id="Quiz"><b>Quiz</b></li>
                <li id="Challenge">Challenge</li>
                <li id="Dashboard">Dashboard</li>
                <li><a href="#">About us</a></li>
            </ul> 
        </div> -->
        <div class="container">
            <div class="spinner hidden" id="spinner"></div>
            <div class="header">
                <h2 class="logo"><img  src="./images/logo.png" style="width: 120px; height:auto"/>planeatary</h2>
                <!-- <span style="font-size:2em;cursor:pointer" onclick="openNav()">&#9776;</span> -->
                <nav class="forwindow">
                    <ul>
                        <!-- <li id="H"><a href="index.html">Home</a></li> -->
                        <!--
                            <li id="Q"><b>Quiz</b></li>
                            <li id="CH">Challenge/li>
                            <li id="D">Dashboard</li> -->
                        <!-- <li>About us</li> -->
                    </ul>
                </nav>
                <!-- <div class="button">
                    <button class="signIn">Sign In</button>
                    <span>&ensp;</span>
                    <button class="signUp">Sign Up</button>
                    </div> -->
            </div>
            <div class="welcome-content">
                <div class="greeting">
                    <h3>Welcome to the PlanEATary Quest!</h3>
                    <h4>Promoting planetary health, one bite at a time.</h4>
                    <p><label><input type="checkbox" id="donePreQuiz"> I have done a pre-quiz before.</label></p>
                    <div class="questions" id="checkIdDiv" style="display: none; line-height: 1cm;">
                        <span class="info-icon" id="checkIdInfo" title="The ID was sent to the email provided in the response.">â“˜</span>
                        <input type="text" id="checkIdInp" placeholder="Your response ID">
                        <button class="next disabled" id="checkIdBtn" disabled>Check</button>
                        <span id="checkIdMsg"></span>
                    </div>
                </div>
            </div>
            <div class="button_next">
                <button class="next disabled" id="resultsBtn" disabled style="display: none;">See results</button>
                <button class="next" id="continueButton"><a href="qualtrics">Take pre-quiz</a></button>
            </div>
            <section class="overlay hidden" id="modalOverlay">
                <div class="align">
                    <div class="modal hidden" id="taskModal"> 
                        <div class="btn">
                            <button class="close">x</button>
                        </div>
                        <div class="modal-content">
                            <h4 id="modalTitle" style="text-align: center;"></h4>
                            <p id="modalDescription"></p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <script type="module">
        import { reformatQualtricsData, saveLocalStorage } from './data-functions.mjs';

        window.openNav = function() {
            document.getElementById("mySidenav").style.width = "40%";
            document.body.style.backgroundColor = "rgba(255,255,255,255,0.4)";
        };

        window.closeNav = function() {
            document.getElementById("mySidenav").style.width = "0";
            document.body.style.backgroundColor = "white";
        };

        document.addEventListener("DOMContentLoaded", function() {
            const spinner = document.getElementById('spinner');
            const greetingDiv = document.querySelector('.greeting');
            const continueButton = document.getElementById('continueButton');
            const modal = document.querySelector(".modal");
            const modalTitle = document.getElementById('modalTitle');
            const modalDescription = document.getElementById('modalDescription');
            const overlay = document.querySelector(".overlay");
            const closeButt = document.querySelector('.close');

            const resultsUrl = 'result_page';
            const green = '#02897A';
            const red = '#ff6b6b';
            const doneChkbox = document.getElementById('donePreQuiz');
            const infoIcon = document.getElementById('checkIdInfo');
            const checkIdDiv = document.getElementById('checkIdDiv');
            const checkIdInp = document.getElementById('checkIdInp');
            const checkIdBtn = document.getElementById('checkIdBtn');
            const resultsBtn = document.getElementById('resultsBtn');
            const checkIdMsg = document.getElementById('checkIdMsg');

            let isLoading = false;
            const minDisplayTime = 1000;
            let spinnerStartTime;

            // Function to show the spinner
            function showSpinner() {
                //console.log("Showing spinner...");
                spinner.classList.remove('hidden');
                overlay.classList.remove('hidden');
                isLoading = true;
                spinnerStartTime = Date.now();
            };

            // Function to hide the spinner
            function hideSpinner() {
                const elapsedTime = Date.now() - spinnerStartTime;
                if (elapsedTime < minDisplayTime) {
                    // Delay hiding spinner until the minimum display time
                    setTimeout(() => {
                        //console.log("Hiding spinner after min time...");
                        spinner.classList.add('hidden');
                        overlay.classList.add('hidden');
                        isLoading = false;
                    }, minDisplayTime - elapsedTime);
                } else {
                    // console.log("Hiding spinner...");
                    spinner.classList.add('hidden');
                    overlay.classList.add('hidden');
                    isLoading = false;
                }
            }

            // Function to show the modal
            function showModal(title = '', description = '') {
                closeButt.classList.remove('hidden');
                modalTitle.textContent = title;
                modalDescription.innerHTML = description;
                modal.classList.remove("hidden");
                modal.style.backgroundColor = 'white';
                modalOverlay.classList.remove("hidden");
            }

            // Function to close the modal
            function closeModal() {
                closeButt.classList.remove('hidden');
                modalTitle.textContent = '';
                modalDescription.innerHTML = '';
                modal.classList.add("hidden");
                modalOverlay.classList.add("hidden");
            }

            // Close modal when user clicks the close button
            document.querySelector(".close").addEventListener("click", closeModal);

            // Close modal when user clicks outside the modal
            window.addEventListener("click", function(event) {
                if (event.target === modalOverlay) {
                    closeModal();
                }
            });

            async function checkOrFetchResponseId() {

                try {
                    showSpinner();
                    let preResponseId = localStorage.getItem('preResult');
                    let postResponseId = localStorage.getItem('postResult');
                    let quizType = '';

                    if (preResponseId) {
                        let userChoice = confirm("Looks like there is your recorded pre quiz. Would you like to continue with existing responses? Click OK if yes.");

                        if (userChoice) {
                            setupContinueButton('result_page.html');
                        } else {
                            // User chooses to start a new quiz
                            localStorage.removeItem('preResult');

                            setupContinueButton('qualtrics.html');

                        }
                    } else if (postResponseId) {
                        let userChoice = confirm("Looks like there is your recorded post quiz. Would you like to start over? Click OK if yes.");

                        if (userChoice) {
                            localStorage.removeItem('preResult');
                            localStorage.removeItem('postResult');
                            setupContinueButton('qualtrics.html');
                        }

                    } else {
                        // If no responseId in localStorage, ask the user if they've completed the pre-quiz
                        const userAns = confirm("Have you done the quiz? Click OK if yes, cancel if no.");

                        if (userAns) {
                            const userOption = confirm("Would you like to continue with existing response? Click OK if yes.");

                            if (userOption) {

                                let preOrpost = prompt("If you would like to proceed with pre-quiz, type 'pre'");

                                // Validate the input
                                if (preOrpost !== 'pre') {
                                    alert("Invalid input. Please enter 'pre'.");
                                    setupContinueButton('qualtrics.html');
                                    hideSpinner();
                                    return;
                                }

                                let userMem = prompt("Please enter its response ID:");

                                if (userMem) {
                                    let responseId = userMem;
                                    let fetchedResponseId = await fetchResponseIdFromNetlify(preOrpost, responseId);
                                    // localStorage.setItem(`${preOrpost}ResponseId`, JSON.stringify(fetchedResponseId));
                                    saveLocalStorage(fetchedResponseId, 'response');
                                    setupContinueButton(preOrpost === 'pre' ?'result_page.html':'manifesto_page.html');
                                    return;
                                } else {
                                    alert("Invalid response ID entered.");
                                    hideSpinner();
                                    return;
                                }
                            } else {
                                setupContinueButton('qualtrics.html');
                            }
                        } else {
                            setupContinueButton('qualtrics.html');
                        }

                    }

                } catch (error) {
                    console.error('Error in checkOrFetchResponseId:', error);
                } finally {
                    hideSpinner();
                }
            }

            async function fetchResponseIdFromNetlify(quizType, responseId) {
                try {

                    const endpoint = `/api/fetch-response?quizType=${quizType}`;
                    const options = {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Q-RESPONSE-ID': responseId,
                        },
                    };

                    // Fetch the responseId from the Netlify endpoint
                    const response = await fetch(endpoint, options);

                    // Check if the response is successful
                    if (!response.ok) {
                        throw new Error(`${response.status}: ${await response.text() || response.body}`);
                    }

                    // Parse the JSON response
                    const data = await response.json();

                    data.quizType = quizType;

                    console.log('Successful fetch.', '\n', data);

                    return reformatQualtricsData(data, 'response');
                } catch (error) {
                    console.error(error);
                    throw error;
                }
            }

            function setupContinueButton(path) {
                continueButton.addEventListener('click', function() {
                    window.location.href = path;
                });
            }

            function setupNavBar() {
                const quiz = document.getElementById('Q');
                const challenge = document.getElementById('CH');
                const dashboard = document.getElementById('D');
            }

            function disableButton(button) {
                button.disabled = true;
                button.classList.add('disabled');
            }

            function enableButton(button, href=null) {
                button.disabled = false;
                button.classList.remove('disabled');
                if (href) {
                    button.innerHTML = `<a href="${href}">${button.textContent}</a>`;
                }
            }

            function renderOutcome(success, message='', color='') {
                if (success === true) {
                    checkIdMsg.style.color = color || green;
                    checkIdMsg.textContent = message;
                    enableButton(resultsBtn, resultsUrl);
                    continueButton.querySelector('a').textContent = 'Re-take pre-quiz';

                } else {
                    checkIdMsg.style.color = color || red;
                    checkIdMsg.textContent = message;
                }
            }

            doneChkbox.addEventListener('change', function() {
                checkIdDiv.style.display = this.checked ? '' : 'none';
                resultsBtn.style.display = this.checked ? '' : 'none';

                if (this.checked) {
                    const preResult = localStorage.getItem('preResult');
                    if (preResult) {
                        const message = 'Your response is already saved in this device.';
                        renderOutcome(true, message);
                    }
                } else {
                    disableButton(checkIdBtn);
                    disableButton(resultsBtn);
                    checkIdInp.value = '';
                    checkIdMsg.textContent = '';
                    continueButton.querySelector('a').textContent = 'Take pre-quiz';
                }
            });

            infoIcon.addEventListener('click', function(event) {
                event.stopPropagation(); 
                showModal(this.title);
            });

            checkIdInp.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    disableButton(checkIdBtn);
                } else {
                    enableButton(checkIdBtn);
                }
                checkIdMsg.textContent = '';
            });

            checkIdBtn.addEventListener('click', async function() {
                try {
                    showSpinner();
                    const fetchedResponseId = await fetchResponseIdFromNetlify('pre', checkIdInp.value);
                    saveLocalStorage(fetchedResponseId, 'response');
                    const message = 'We found your response and saved it in this device!';
                    renderOutcome(true, message);
                    hideSpinner();

                } catch(error) {
                    const message = 'Sorry, we cannot find this ID.';
                    renderOutcome(false, message);
                    hideSpinner();
                }
            });

            // checkOrFetchResponseId();
        });
        </script>
    </body>
</html>
