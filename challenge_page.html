<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Poppins&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Inter&display=swap" rel="stylesheet" />
    <link href="style_concat.css" rel="stylesheet" />
    <title>PlanEATary Challenges</title>
</head>
<body>
    <!-- Sidebar -->
    <div id="mySidenav" class="sidenav">
        <ul>
            <li><a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a></li>
            <li><a href="index.html">Home</a></li>
            <li><a href="qualtrics.html"><b>Quiz</b></a></li>
            <li><a href="manifesto.html">Challenge</a></li>
            <li><a href="result_page.html">Dashboard</a></li>
        </ul>
    </div>
    <div class="container">
        <div class="spinner hidden" id="spinner"></div>
        <div class="header">
            <h2 class="logo">planeatary - logo</h2>
            <span style="font-size:2em;cursor:pointer" onclick="openNav()">&#9776;</span>
            <nav class="forwindow">
                <ul>
                    <li>Home</li>
                    <li><a href="qualtrics.html"><b>Quiz</b></a></li>
                    <li><a href="manifesto.html">Challenge</a></li>
                    <li><a href="result_page.html">Dashboard</a></li>
                    <!-- <li>About us</li> -->
                </ul>
            </nav>
            <!-- <div class="button">
                <button class="signIn">Sign In</button>
                <span>&ensp;</span>
                <button class="signUp">Sign Up</button>
            </div> -->
        </div>
        <div class="content">
            <div class="head">
                <img src="./images/battery.png"/>
                <h1 class="status">CHALLENGE IN PROGRESS</h1>
                <p class="suggestion">Please click Done when you complete your tasks</p>
            </div>
            <div class="card"></div>
        </div>
    </div>

    <!-- The Modal -->
    <section class="overlay hidden">
        <div class="align">
            <div class="modal hidden"> 
                <div class="btn">
                    <button class="close" onclick="Close();">x</button>
                </div>
                <div class="modal-content">
                    <img />
                </div>
            </div>
        </div>
    </section>

    <script>
        function openNav() {
            next = document.querySelector(".next");
            next.style.cursor = "not-allowed";
            document.getElementById("mySidenav").style.width = "40%";
            document.body.style.backgroundColor = "rgba(255,255,255,255,0.4)";
        };

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
            document.body.style.backgroundColor = "white";
        };

        let scores = [];

        const content = document.querySelector(".content");
        const cardContainer = document.querySelector(".card");
        // Create and append the next button
        const nextContainer = document.createElement("div");
        nextContainer.classList.add("btn-next");
        
        const btn_next = document.createElement("button");
        btn_next.classList.add("next");
        btn_next.innerHTML = "Next";
        btn_next.style.pointerEvents = "none"; // Disable initially
        btn_next.style.backgroundColor = "grey"; // Disable color initially
        btn_next.style.cursor = "not-allowed"; // Show disabled cursor
        
        nextContainer.appendChild(btn_next);
        content.appendChild(nextContainer);

        document.addEventListener("DOMContentLoaded", function() {

            const spinner = document.getElementById('spinner');
            let isLoading = false;
            const minDisplayTime = 2000; 
            let spinnerStartTime;

            /// Function to show the spinner
            function showSpinner() {
                    //console.log("Showing spinner...");
                    spinner.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                    isLoading = true;
                    spinnerStartTime = Date.now();
            };
                
            // Function to hide the spinner
            function hideSpinner() {
                const elapsedTime = Date.now() - spinnerStartTime;
                if (elapsedTime < minDisplayTime) {
                    // Delay hiding spinner until the minimum display time
                        setTimeout(() => {
                        //console.log("Hiding spinner after min time...");
                        spinner.classList.add('hidden');
                        overlay.classList.add('hidden');
                        isLoading = false;
                    }, minDisplayTime - elapsedTime);
                } else {
                        console.log("Hiding spinner...");
                        spinner.classList.add('hidden');
                        overlay.classList.add('hidden');
                        isLoading = false;
                }
            };
            showSpinner();

            // Check if scores are stored in localStorage
            
            const storedScore = localStorage.getItem("user");
            if (storedScore) {
                // Parse and use scores from localStorage
                scores = JSON.parse(storedScore);
                displayTasksFromScores(scores);
                hideSpinner();
            } else {
                
            }

            async function updateTasks(chosenTasks, doneTasks) {
                    try {
                        let surveyResponses = localStorage.getItem('preResponseId');
                        if (!surveyResponses) {
                            console.error('preResponseId is not available in localStorage.');
                            return;
                        }

                        const endpoint = '/api/manage-tasks';
                        const body = {
                            id: surveyResponses.result.responseId,
                            chosen: chosenTasks,
                            done: doneTasks,
                        };

                        const options = {

                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Q-RESPONSE-ID': surveyResponses.result.responseId,
                            },
                            body: JSON.stringify(body),
                        };

                        const response = await fetch(endpoint, options);
                        if (!response.ok) {
                            throw new Error(`Failed to update tasks: ${response.status} ${response.statusText}`);
                        }
                        console.log('Tasks updated successfully!');
                    } catch (error) {
                        console.error('Error updating tasks:', error);
                    }
                }


            // Function to display tasks
            function displayTasksFromScores(scores) {
                cardContainer.innerHTML = ''; // Clear any existing content
                scores.forEach((scoreObj, i) => {
                    const tasks = scoreObj.tasks;
                    tasks.forEach((task, j) => {
                        if (task.choice === 'selected') {
                            const taskCard = document.createElement("div");
                            taskCard.classList.add(task.status === "Completed" ? "card_completed" : "card_incompleted");

                            const taskName = document.createElement("span");
                            taskName.id = `task${i}_${j}`;
                            taskName.innerHTML = task.taskName;

                            const info = document.createElement("img");
                            info.src = "./images/info.png";
                            info.style.width = "5%";
                            info.alt = "Info Icon";
                            info.addEventListener('click', function(event) {
                                event.stopPropagation();
                                event.preventDefault();
                                Modal();
                            });

                            const completion = document.createElement("span");
                            completion.classList.add("completion");
                            completion.innerHTML = task.status;

                            // Event listener to toggle task status
                            taskCard.addEventListener('click', function() {
                                toggleTaskStatus(i, j);

                            });

                            taskCard.appendChild(taskName);
                            taskCard.appendChild(info);
                            taskCard.appendChild(completion);
                            cardContainer.appendChild(taskCard);

                            // Check the updated task status
                            if (task.status === "Completed") {
                                // Add strikethrough effect to the task name
                                taskName.style.textDecoration = "line-through";
                            } else {

                                // Remove strikethrough effect from the task name
                                taskName.style.textDecoration = "none";
                            }

                        }
                    });
                });
                updateNextButton(); 
            }

            function toggleTaskStatus(scoreIndex, taskIndex) {
                const tasks = scores[scoreIndex].tasks;

                // Allow changing the status only from "Done" to "Completed"
                if (tasks[taskIndex].status === "Done") {
                    tasks[taskIndex].status = "Completed"; 
                }

                // Update stored scores in localStorage
                localStorage.setItem("user", JSON.stringify(scores));

                // Re-render the tasks
                displayTasksFromScores(scores);
            }

            // Function to update the Next button's state
            function updateNextButton() {
                let allCompleted = true;
                scores.forEach((scoreObj) => {
                    scoreObj.tasks.forEach((task) => {
                        if (task.choice === "selected" && task.status !== "Completed") {
                            allCompleted = false; // If any selected task is not "Completed", set false
                        }
                    });
                });

                // Enable or disable the next button based on task completion status
                if (allCompleted) {
                    btn_next.style.pointerEvents = "auto"; // Enable the next button
                    btn_next.style.backgroundColor = "#02897A"; // Update button color when enabled
                    btn_next.style.cursor = "pointer"; 
                    // Attach click listener to next button
                    btn_next.addEventListener("click", function() {
                        if (btn_next.style.pointerEvents === "auto") {
                            let text = "Would you like to proceed to the post quiz?"
                            if(confirm(text) == true) {
                                window.location.href = "congrat_page.html";
                            }
                        }
                    });
                } else {
                    btn_next.style.pointerEvents = "none"; // Disable the next button
                    btn_next.style.backgroundColor = "grey"; // Keep it grey if not all tasks are completed
                    btn_next.style.cursor = "not-allowed"; 
                }
            }

        });

        const modal = document.querySelector(".modal");
        const overlay = document.querySelector(".overlay");

        function Modal() {
            modal.classList.remove("hidden");
            overlay.classList.remove("hidden");
        }

        function Close() {
            modal.classList.add("hidden");
            overlay.classList.add("hidden");
        }
    </script>
</body>
</html>